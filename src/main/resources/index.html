<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>Solid App</title>
    <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function s(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=s(n);fetch(n.href,o)}})();const H=!1,K=(t,e)=>t===e,C={equals:K};let Q=$;const m=1,v=2,j={owned:null,cleanups:null,context:null,owner:null};var a=null;let I=null,X=null,c=null,u=null,w=null,U=0;function Y(t,e){const s=c,i=a,n=t.length===0,o=e===void 0?i:e,l=n?j:{owned:null,cleanups:null,context:o?o.context:null,owner:o},r=n?t:()=>t(()=>S(()=>g(l)));a=l,c=null;try{return b(r,!0)}finally{c=s,a=i}}function k(t,e){e=e?Object.assign({},C,e):C;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},i=n=>(typeof n=="function"&&(n=n(s.value)),W(s,n));return[D.bind(s),i]}function P(t,e,s){const i=B(t,e,!1,m);x(i)}function L(t,e,s){s=s?Object.assign({},C,s):C;const i=B(t,e,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=s.equals||void 0,x(i),D.bind(i)}function S(t){if(c===null)return t();const e=c;c=null;try{return t()}finally{c=e}}function Z(t){return a===null||(a.cleanups===null?a.cleanups=[t]:a.cleanups.push(t)),t}function D(){if(this.sources&&this.state)if(this.state===m)x(this);else{const t=u;u=null,b(()=>A(this),!1),u=t}if(c){const t=this.observers?this.observers.length:0;c.sources?(c.sources.push(this),c.sourceSlots.push(t)):(c.sources=[this],c.sourceSlots=[t]),this.observers?(this.observers.push(c),this.observerSlots.push(c.sources.length-1)):(this.observers=[c],this.observerSlots=[c.sources.length-1])}return this.value}function W(t,e,s){let i=t.value;return(!t.comparator||!t.comparator(i,e))&&(t.value=e,t.observers&&t.observers.length&&b(()=>{for(let n=0;n<t.observers.length;n+=1){const o=t.observers[n],l=I&&I.running;l&&I.disposed.has(o),(l?!o.tState:!o.state)&&(o.pure?u.push(o):w.push(o),o.observers&&_(o)),l||(o.state=m)}if(u.length>1e6)throw u=[],new Error},!1)),e}function x(t){if(!t.fn)return;g(t);const e=U;z(t,t.value,e)}function z(t,e,s){let i;const n=a,o=c;c=a=t;try{i=t.fn(e)}catch(l){return t.pure&&(t.state=m,t.owned&&t.owned.forEach(g),t.owned=null),t.updatedAt=s+1,q(l)}finally{c=o,a=n}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?W(t,i):t.value=i,t.updatedAt=s)}function B(t,e,s,i=m,n){const o={fn:t,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:a,context:a?a.context:null,pure:s};return a===null||a!==j&&(a.owned?a.owned.push(o):a.owned=[o]),o}function J(t){if(t.state===0)return;if(t.state===v)return A(t);if(t.suspense&&S(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<U);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===m)x(t);else if(t.state===v){const i=u;u=null,b(()=>A(t,e[0]),!1),u=i}}function b(t,e){if(u)return t();let s=!1;e||(u=[]),w?s=!0:w=[],U++;try{const i=t();return ee(s),i}catch(i){s||(w=null),u=null,q(i)}}function ee(t){if(u&&($(u),u=null),t)return;const e=w;w=null,e.length&&b(()=>Q(e),!1)}function $(t){for(let e=0;e<t.length;e++)J(t[e])}function A(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const i=t.sources[s];if(i.sources){const n=i.state;n===m?i!==e&&(!i.updatedAt||i.updatedAt<U)&&J(i):n===v&&A(i,e)}}}function _(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=v,s.pure?u.push(s):w.push(s),s.observers&&_(s))}}function g(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),i=t.sourceSlots.pop(),n=s.observers;if(n&&n.length){const o=n.pop(),l=s.observerSlots.pop();i<n.length&&(o.sourceSlots[l]=i,n[i]=o,s.observerSlots[i]=l)}}if(t.tOwned){for(e=t.tOwned.length-1;e>=0;e--)g(t.tOwned[e]);delete t.tOwned}if(t.owned){for(e=t.owned.length-1;e>=0;e--)g(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function te(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function q(t,e=a){throw te(t)}function F(t,e){return S(()=>t(e||{}))}const se=t=>`Stale read from <${t}>.`;function ne(t){const e=t.keyed,s=L(()=>t.when,void 0,void 0),i=e?s:L(s,void 0,{equals:(n,o)=>!n==!o});return L(()=>{const n=i();if(n){const o=t.children;return typeof o=="function"&&o.length>0?S(()=>o(e?n:()=>{if(!S(i))throw se("Show");return s()})):o}return t.fallback},void 0,void 0)}function ie(t,e,s){let i=s.length,n=e.length,o=i,l=0,r=0,f=e[n-1].nextSibling,h=null;for(;l<n||r<o;){if(e[l]===s[r]){l++,r++;continue}for(;e[n-1]===s[o-1];)n--,o--;if(n===l){const d=o<i?r?s[r-1].nextSibling:s[o-r]:f;for(;r<o;)t.insertBefore(s[r++],d)}else if(o===r)for(;l<n;)(!h||!h.has(e[l]))&&e[l].remove(),l++;else if(e[l]===s[o-1]&&s[r]===e[n-1]){const d=e[--n].nextSibling;t.insertBefore(s[r++],e[l++].nextSibling),t.insertBefore(s[--o],d),e[n]=s[o]}else{if(!h){h=new Map;let p=r;for(;p<o;)h.set(s[p],p++)}const d=h.get(e[l]);if(d!=null)if(r<d&&d<o){let p=l,N=1,M;for(;++p<n&&p<o&&!((M=h.get(e[p]))==null||M!==d+N);)N++;if(N>d-r){const G=e[l];for(;r<d;)t.insertBefore(s[r++],G)}else t.replaceChild(s[r++],e[l++])}else l++;else e[l++].remove()}}}function oe(t,e,s,i={}){let n;return Y(o=>{n=o,e===document?t():E(e,t(),e.firstChild?null:void 0,s)},i.owner),()=>{n(),e.textContent=""}}function V(t,e,s,i){let n;const o=()=>{const r=document.createElement("template");return r.innerHTML=t,r.content.firstChild},l=()=>(n||(n=o())).cloneNode(!0);return l.cloneNode=l,l}function E(t,e,s,i){if(s!==void 0&&!i&&(i=[]),typeof e!="function")return O(t,e,i,s);P(n=>O(t,e(),n,s),i)}function O(t,e,s,i,n){for(;typeof s=="function";)s=s();if(e===s)return s;const o=typeof e,l=i!==void 0;if(t=l&&s[0]&&s[0].parentNode||t,o==="string"||o==="number"){if(o==="number"&&(e=e.toString(),e===s))return s;if(l){let r=s[0];r&&r.nodeType===3?r.data!==e&&(r.data=e):r=document.createTextNode(e),s=y(t,s,i,r)}else s!==""&&typeof s=="string"?s=t.firstChild.data=e:s=t.textContent=e}else if(e==null||o==="boolean")s=y(t,s,i);else{if(o==="function")return P(()=>{let r=e();for(;typeof r=="function";)r=r();s=O(t,r,s,i)}),()=>s;if(Array.isArray(e)){const r=[],f=s&&Array.isArray(s);if(T(r,e,s,n))return P(()=>s=O(t,r,s,i,!0)),()=>s;if(r.length===0){if(s=y(t,s,i),l)return s}else f?s.length===0?R(t,r,i):ie(t,s,r):(s&&y(t),R(t,r));s=r}else if(e.nodeType){if(Array.isArray(s)){if(l)return s=y(t,s,i,e);y(t,s,null,e)}else s==null||s===""||!t.firstChild?t.appendChild(e):t.replaceChild(e,t.firstChild);s=e}}return s}function T(t,e,s,i){let n=!1;for(let o=0,l=e.length;o<l;o++){let r=e[o],f=s&&s[t.length],h;if(!(r==null||r===!0||r===!1))if((h=typeof r)=="object"&&r.nodeType)t.push(r);else if(Array.isArray(r))n=T(t,r,f)||n;else if(h==="function")if(i){for(;typeof r=="function";)r=r();n=T(t,Array.isArray(r)?r:[r],Array.isArray(f)?f:[f])||n}else t.push(r),n=!0;else{const d=String(r);f&&f.nodeType===3&&f.data===d?t.push(f):t.push(document.createTextNode(d))}}return n}function R(t,e,s=null){for(let i=0,n=e.length;i<n;i++)t.insertBefore(e[i],s)}function y(t,e,s,i){if(s===void 0)return t.textContent="";const n=i||document.createTextNode("");if(e.length){let o=!1;for(let l=e.length-1;l>=0;l--){const r=e[l];if(n!==r){const f=r.parentNode===t;!o&&!l?f?t.replaceChild(n,r):t.insertBefore(n,s):f&&r.remove()}else o=!0}}else t.insertBefore(n,s);return[n]}class re{ws=null;localStream=null;peers=new Map;remoteStreams=new Map;userInfo=new Map;audioElements=new Map;onUsersUpdate;onError;onConnected;onClose;constructor(e,s,i,n){this.onUsersUpdate=e,this.onError=s,this.onConnected=i,this.onClose=n}async connect(e){try{this.localStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});const s=void 0,n=s&&s.trim().length>0?s:"wss://proximitycraft.com";this.ws=new WebSocket(n),this.ws.onopen=()=>{this.ws.send(JSON.stringify({type:"join",fromSessionId:e}))},this.ws.onmessage=async o=>{const l=JSON.parse(o.data);await this.handleSignalingMessage(l)},this.ws.onerror=o=>{console.error("WebSocket error:",o),this.onError("Connection error. Make sure the server is running.")},this.ws.onclose=()=>{this.cleanup()}}catch(s){console.error("Error connecting:",s),this.onError("Failed to access microphone or connect to server")}}async handleSignalingMessage(e){switch(e.type){case"joined":this.onConnected(e.username);break;case"user-joined":this.userInfo.set(e.sessionId,{username:e.username}),await this.createPeerConnection(e.sessionId,e.shouldInitiate),this.audioElements.get(e.sessionId).volume=e.volume;break;case"update-volume":this.audioElements.get(e.sessionId).volume=e.volume;break;case"user-left":this.removePeerConnection(e.sessionId);break;case"offer":!this.userInfo.has(e.fromSessionId)&&e.fromUsername&&this.userInfo.set(e.fromSessionId,{username:e.fromUsername}),await this.handleOffer(e);break;case"answer":!this.userInfo.has(e.fromSessionId)&&e.fromUsername&&this.userInfo.set(e.fromSessionId,{username:e.fromUsername}),await this.handleAnswer(e);break;case"ice-candidate":await this.handleIceCandidate(e);break;case"error":this.onError(e.message);break}}async createPeerConnection(e,s){console.log("Creating peer connection for",e);const i=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});if(this.peers.set(e,i),this.localStream&&this.localStream.getTracks().forEach(n=>{i.addTrack(n,this.localStream)}),i.ontrack=n=>{n.streams[0]&&(this.remoteStreams.set(e,n.streams[0]),this.playRemoteStream(e,n.streams[0]),this.updateUsersList())},i.onicecandidate=n=>{n.candidate&&this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"ice-candidate",targetSessionId:e,candidate:n.candidate}))},s){const n=await i.createOffer();await i.setLocalDescription(n),this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"offer",targetSessionId:e,offer:n}))}this.updateUsersList()}async handleOffer(e){const s=this.peers.get(e.fromSessionId)||await this.createPeerConnection(e.fromSessionId,!1);if(s){await s.setRemoteDescription(e.offer);const i=await s.createAnswer();await s.setLocalDescription(i),this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify({type:"answer",targetSessionId:e.fromSessionId,answer:i}))}}async handleAnswer(e){const s=this.peers.get(e.fromSessionId);s&&await s.setRemoteDescription(e.answer)}async handleIceCandidate(e){const s=this.peers.get(e.fromSessionId);s&&await s.addIceCandidate(e.candidate)}playRemoteStream(e,s){const i=this.audioElements.get(e);i&&(i.srcObject=null,i.remove());const n=document.createElement("audio");n.srcObject=s,n.autoplay=!0,document.body.appendChild(n),this.audioElements.set(e,n),n.play().catch(o=>{console.error("Error playing audio:",o),document.addEventListener("click",()=>{n.play().catch(l=>console.error("Still cannot play:",l))},{once:!0})})}removePeerConnection(e){const s=this.peers.get(e);s&&(s.close(),this.peers.delete(e));const i=this.audioElements.get(e);i&&(i.srcObject=null,i.remove(),this.audioElements.delete(e)),this.remoteStreams.delete(e),this.userInfo.delete(e),this.updateUsersList()}updateUsersList(){const e=[];this.remoteStreams.forEach((s,i)=>{const n=this.userInfo.get(i);e.push({username:n?.username||`User-${i.substring(0,6)}`,sessionId:i,stream:s})}),this.onUsersUpdate(e)}disconnect(){this.ws?.readyState===WebSocket.OPEN&&(this.ws.send(JSON.stringify({type:"leave"})),this.ws.close()),this.cleanup()}cleanup(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.audioElements.forEach(e=>{e.srcObject=null,e.remove()}),this.audioElements.clear(),this.peers.forEach(e=>e.close()),this.peers.clear(),this.remoteStreams.clear(),this.userInfo.clear(),this.ws&&(this.ws.close(),this.ws=null),this.onClose()}}var le=V("<div class=error-message>⚠️ "),ce=V("<div class=app><h1>Proximitycraft</h1><div class=status>");const ae=()=>{const[t,e]=k("Connecting..."),[s,i]=k("");let n=null;return(async()=>{i(""),e("Connecting..."),n=new re(()=>{},l=>{i(l),e("Connection failed")},()=>{e("Connected to voice room")},()=>{e("Disconnected from voice room")}),await n.connect(window.location.pathname.split("/").slice(-1)[0])})(),Z(()=>{n&&(n.disconnect(),n=null)}),(()=>{var l=ce(),r=l.firstChild,f=r.nextSibling;return E(f,t),E(l,F(ne,{get when(){return s()},get children(){var h=le();return h.firstChild,E(h,s,null),h}}),null),l})()},fe=document.getElementById("root");oe(()=>F(ae,{}),fe);</script>
    <style rel="stylesheet" crossorigin>body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;margin:20px}</style>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

  </body>
</html>
